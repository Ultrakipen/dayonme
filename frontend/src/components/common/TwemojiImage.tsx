import React, { useMemo } from 'react';
import { Image, StyleSheet, View, Text } from 'react-native';

// Twemoji CDN URL ìƒì„± (72x72 ê³ í•´ìƒë„)
const getTwemojiUrl = (code: string): string =>
  `https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/72x72/${code}.png`;

// ì´ëª¨ì§€ â†’ ìœ ë‹ˆì½”ë“œ ì½”ë“œ í¬ì¸íŠ¸ ë³€í™˜
const emojiToCodePoint = (emoji: string): string => {
  const codePoints: string[] = [];
  for (const char of emoji) {
    const code = char.codePointAt(0);
    if (code) {
      // Variation Selector (FE0F) ì œì™¸
      if (code !== 0xfe0f) {
        codePoints.push(code.toString(16));
      }
    }
  }
  return codePoints.join('-');
};

// ìì£¼ ì‚¬ìš©ë˜ëŠ” ì´ëª¨ì§€ ì½”ë“œ ë§¤í•‘ (ì„±ëŠ¥ ìµœì í™”)
const EMOJI_CODE_MAP: Record<string, string> = {
  // ê°ì •
  'ğŸ˜Š': '1f60a', 'ğŸ˜„': '1f604', 'ğŸ˜¢': '1f622', 'ğŸ˜': '1f61e',
  'ğŸ˜°': '1f630', 'ğŸ˜Ÿ': '1f61f', 'ğŸ˜ ': '1f620', 'ğŸ˜¤': '1f624',
  'ğŸ¥º': '1f97a', 'ğŸ¤¨': '1f928', 'ğŸ˜²': '1f632', 'ğŸ˜¨': '1f628',
  'ğŸ˜Œ': '1f60c', 'ğŸ¥°': '1f970', 'ğŸ¤—': '1f917', 'ğŸ˜‘': '1f611',
  'ğŸ¤”': '1f914', 'â¤ï¸': '2764', 'ğŸ¤•': '1f915', 'ğŸ¤‘': '1f911',
  // UI ì•„ì´ì½˜
  'âœ¨': '2728', 'ğŸ“Š': '1f4ca', 'ğŸ’¬': '1f4ac', 'ğŸ”¥': '1f525',
  'ğŸ“': '1f4dd', 'ğŸ’•': '1f495', 'ğŸµ': '1f3b5', 'ğŸ§': '1f3a7',
  'ğŸ†': '1f3c6', 'ğŸ¯': '1f3af', 'ğŸ’¡': '1f4a1', 'âš¡': '26a1',
  'ğŸ‰': '1f389', 'ğŸŠ': '1f38a', 'ğŸ’ª': '1f4aa', 'ğŸ‘': '1f44f',
  'ğŸŒŸ': '1f31f', 'â­': '2b50', 'ğŸŒ™': '1f319', 'â˜€ï¸': '2600',
  'ğŸŒˆ': '1f308', 'ğŸŒ¸': '1f338', 'ğŸ€': '1f340', 'ğŸŒ»': '1f33b',
  'ğŸ': '1f381', 'ğŸ’': '1f48e', 'ğŸ”®': '1f52e', 'ğŸ“ˆ': '1f4c8',
  'ğŸ“‰': '1f4c9', 'ğŸ’¯': '1f4af', 'ğŸ†•': '1f195', 'âœ…': '2705',
  'âŒ': '274c', 'â°': '23f0', 'ğŸ“…': '1f4c5', 'ğŸ—“ï¸': '1f5d3',
  'ğŸ’Œ': '1f48c', 'ğŸ­': '1f3ad', 'ğŸª': '1f3aa', 'ğŸ¨': '1f3a8',
  'ğŸ¤': '1f3a4', 'ğŸ¬': '1f3ac', 'ğŸ“±': '1f4f1', 'ğŸ’»': '1f4bb',
  'ğŸ–¥ï¸': '1f5a5', 'âŒ¨ï¸': '2328', 'ğŸ””': '1f514', 'ğŸ”•': '1f515',
  'ğŸ’°': '1f4b0', 'ğŸ’µ': '1f4b5', 'ğŸ“': '1f393', 'ğŸ“š': '1f4da',
  'âœï¸': '270f', 'ğŸ–Šï¸': '1f58a', 'ğŸ“Œ': '1f4cc', 'ğŸ“': '1f4cd',
  'ğŸ”’': '1f512', 'ğŸ”“': '1f513', 'ğŸ”‘': '1f511', 'ğŸ—ï¸': '1f5dd',
  'â“': '2753', 'â—': '2757', 'ğŸ’­': '1f4ad', 'ğŸ’¬': '1f4ac',
  'ğŸ‘¤': '1f464', 'ğŸ‘¥': '1f465', 'ğŸ™': '1f64f', 'ğŸ¤': '1f91d',
  'ğŸ‘': '1f44d', 'ğŸ‘': '1f44e', 'âœ‹': '270b', 'ğŸ–ï¸': '1f590',
  'ğŸ‘‹': '1f44b', 'ğŸ¤š': '1f91a', 'ğŸ™Œ': '1f64c', 'ğŸ‘': '1f450',
  'ğŸ’—': '1f497', 'ğŸ’–': '1f496', 'ğŸ’': '1f49d', 'ğŸ’˜': '1f498',
  'ğŸ§ ': '1f9e0', 'ğŸ‘ï¸': '1f441', 'ğŸ‘€': '1f440', 'ğŸ«‚': '1fac2',
  'ğŸ¥²': '1f972', 'ğŸ˜‡': '1f607', 'ğŸ™‚': '1f642', 'ğŸ˜‰': '1f609',
  'ğŸ˜': '1f60d', 'ğŸ¤©': '1f929', 'ğŸ˜˜': '1f618', 'ğŸ˜‹': '1f60b',
  'ğŸ˜œ': '1f61c', 'ğŸ¤ª': '1f92a', 'ğŸ˜': '1f60e', 'ğŸ¤“': '1f913',
  'ğŸ˜­': '1f62d', 'ğŸ˜©': '1f629', 'ğŸ˜«': '1f62b', 'ğŸ¥±': '1f971',
  'ğŸ˜´': '1f634', 'ğŸ˜ª': '1f62a', 'ğŸ¤¤': '1f924', 'ğŸ˜·': '1f637',
  'ğŸ¤’': '1f912', 'ğŸ¤§': '1f927', 'ğŸ¥¶': '1f976', 'ğŸ¥µ': '1f975',
  'ğŸ˜µ': '1f635', 'ğŸ¤¯': '1f92f', 'ğŸ¤ ': '1f920', 'ğŸ¥³': '1f973',
  'ğŸ˜': '1f60f', 'ğŸ˜’': '1f612', 'ğŸ˜”': '1f614', 'ğŸ˜•': '1f615',
  'ğŸ™': '1f641', 'â˜¹ï¸': '2639', 'ğŸ˜£': '1f623', 'ğŸ˜–': '1f616',
  'ğŸ˜¡': '1f621', 'ğŸ¤¬': '1f92c', 'ğŸ˜ˆ': '1f608', 'ğŸ‘¿': '1f47f',
  'ğŸ’€': '1f480', 'â˜ ï¸': '2620', 'ğŸ’©': '1f4a9', 'ğŸ¤¡': '1f921',
  'ğŸ‘¹': '1f479', 'ğŸ‘º': '1f47a', 'ğŸ‘»': '1f47b', 'ğŸ‘½': '1f47d',
  'ğŸ‘¾': '1f47e', 'ğŸ¤–': '1f916', 'ğŸ˜º': '1f63a', 'ğŸ˜¸': '1f638',
  'ğŸ˜¹': '1f639', 'ğŸ˜»': '1f63b', 'ğŸ˜¼': '1f63c', 'ğŸ˜½': '1f63d',
  'ğŸ™€': '1f640', 'ğŸ˜¿': '1f63f', 'ğŸ˜¾': '1f63e', 'ğŸ±': '1f431',
  'ğŸ¶': '1f436', 'ğŸ»': '1f43b', 'ğŸ¼': '1f43c', 'ğŸ¨': '1f428',
  'ğŸ¦Š': '1f98a', 'ğŸ¦': '1f981', 'ğŸ¯': '1f42f', 'ğŸ®': '1f42e',
  'ğŸ·': '1f437', 'ğŸ¸': '1f438', 'ğŸµ': '1f435', 'ğŸ”': '1f414',
  'ğŸ§': '1f427', 'ğŸ¦': '1f426', 'ğŸ¦…': '1f985', 'ğŸ¦†': '1f986',
  'ğŸ¦‰': '1f989', 'ğŸ': '1f41d', 'ğŸ¦‹': '1f98b', 'ğŸŒ': '1f40c',
  'ğŸŒº': '1f33a', 'ğŸŒ¹': '1f339', 'ğŸŒ·': '1f337', 'ğŸŒ¼': '1f33c',
  'ğŸŒ±': '1f331', 'ğŸŒ²': '1f332', 'ğŸŒ³': '1f333', 'ğŸŒ´': '1f334',
  'ğŸŒµ': '1f335', 'ğŸ': '1f341', 'ğŸ‚': '1f342', 'ğŸƒ': '1f343',
  'â˜ï¸': '2601', 'â›…': '26c5', 'ğŸŒ¤ï¸': '1f324', 'ğŸŒ¥ï¸': '1f325',
  'ğŸŒ¦ï¸': '1f326', 'ğŸŒ§ï¸': '1f327', 'â›ˆï¸': '26c8', 'ğŸŒ©ï¸': '1f329',
  'ğŸŒ¨ï¸': '1f328', 'â„ï¸': '2744', 'â˜ƒï¸': '2603', 'â›„': '26c4',
  'ğŸŒªï¸': '1f32a', 'ğŸŒ«ï¸': '1f32b', 'ğŸŒŠ': '1f30a', 'ğŸ’§': '1f4a7',
  'ğŸ’¦': '1f4a6', 'â˜”': '2614', 'ğŸ': '1f34e', 'ğŸŠ': '1f34a',
  'ğŸ‹': '1f34b', 'ğŸŒ': '1f34c', 'ğŸ‰': '1f349', 'ğŸ‡': '1f347',
  'ğŸ“': '1f353', 'ğŸ«': '1fad0', 'ğŸ‘': '1f351', 'ğŸ’': '1f352',
  'ğŸ¥': '1f95d', 'ğŸ…': '1f345', 'ğŸ¥‘': '1f951', 'ğŸ¥•': '1f955',
  'ğŸŒ½': '1f33d', 'ğŸ¥¦': '1f966', 'ğŸ§„': '1f9c4', 'ğŸ§…': '1f9c5',
  'ğŸ”': '1f354', 'ğŸŸ': '1f35f', 'ğŸ•': '1f355', 'ğŸŒ­': '1f32d',
  'ğŸ¥ª': '1f96a', 'ğŸŒ®': '1f32e', 'ğŸŒ¯': '1f32f', 'ğŸ¥—': '1f957',
  'ğŸœ': '1f35c', 'ğŸ': '1f35d', 'ğŸ£': '1f363', 'ğŸ±': '1f371',
  'ğŸ©': '1f369', 'ğŸª': '1f36a', 'ğŸ‚': '1f382', 'ğŸ°': '1f370',
  'ğŸ§': '1f9c1', 'ğŸ«': '1f36b', 'ğŸ¬': '1f36c', 'ğŸ­': '1f36d',
  'ğŸ®': '1f36e', 'ğŸ¯': '1f36f', 'â˜•': '2615', 'ğŸµ': '1f375',
  'ğŸ§ƒ': '1f9c3', 'ğŸ¥¤': '1f964', 'ğŸ§‹': '1f9cb', 'ğŸ¶': '1f376',
  'ğŸ¾': '1f37e', 'ğŸ·': '1f377', 'ğŸ¸': '1f378', 'ğŸ¹': '1f379',
  'ğŸº': '1f37a', 'ğŸ»': '1f37b', 'ğŸ¥‚': '1f942', 'ğŸ¥ƒ': '1f943',
};

interface TwemojiImageProps {
  emoji: string;
  size?: number;
  style?: object;
  fallbackToText?: boolean;
}

export const TwemojiImage: React.FC<TwemojiImageProps> = React.memo(({
  emoji,
  size = 24,
  style,
  fallbackToText = true,
}) => {
  const emojiCode = useMemo(() => {
    // ë§¤í•‘ í…Œì´ë¸”ì—ì„œ ë¹ ë¥´ê²Œ ì°¾ê¸°
    if (EMOJI_CODE_MAP[emoji]) {
      return EMOJI_CODE_MAP[emoji];
    }
    // ì—†ìœ¼ë©´ ë™ì  ë³€í™˜
    return emojiToCodePoint(emoji);
  }, [emoji]);

  const imageUrl = useMemo(() => getTwemojiUrl(emojiCode), [emojiCode]);

  const [hasError, setHasError] = React.useState(false);

  if (hasError && fallbackToText) {
    return (
      <View style={[styles.container, { width: size, height: size }, style]}>
        <Text style={{ fontSize: size * 0.8, lineHeight: size }}>{emoji}</Text>
      </View>
    );
  }

  return (
    <Image
      source={{ uri: imageUrl }}
      style={[{ width: size, height: size }, style]}
      resizeMode="contain"
      onError={() => setHasError(true)}
    />
  );
});

const styles = StyleSheet.create({
  container: {
    justifyContent: 'center',
    alignItems: 'center',
  },
});

export default TwemojiImage;
